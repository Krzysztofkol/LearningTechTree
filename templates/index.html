<!DOCTYPE html>
<html>
<head>
    <title>Learning Tech Tree</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 1rem;
        }
        #graph-container {
            position: relative;
            display: inline-block;
            margin-top: 1rem;
        }
        #graph {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
        }
        area {
            cursor: pointer;
        }
        #hover-indicator {
            position: absolute;
            border: 2px solid red;
            pointer-events: none;
            display: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Learning Tech Tree</h1>
        <div id="graph-container">
            <img src="{{ graph_file }}" usemap="#DeepLearningPath" id="graph">
            {{ image_map|safe }}
            <div id="hover-indicator"></div>
        </div>
    </div>
    <script>
        console.log("Script started");
        const graph = document.getElementById('graph');
        const hoverIndicator = document.getElementById('hover-indicator');
        let progress = {{ progress|safe }};
        let nodeCoordinates = {};
        function showHoverIndicator(coords) {
            console.log("showHoverIndicator called with coords:", coords);
            const [x, y, width, height] = coords.split(',').map(Number);
            hoverIndicator.style.left = `${x}px`;
            hoverIndicator.style.top = `${y}px`;
            hoverIndicator.style.width = `${width - x}px`;
            hoverIndicator.style.height = `${height - y}px`;
            hoverIndicator.style.display = 'block';
        }
        function hideHoverIndicator() {
            console.log("hideHoverIndicator called");
            hoverIndicator.style.display = 'none';
        }
        function isPointInNode(x, y, node) {
            const [nodeX, nodeY, nodeWidth, nodeHeight] = node;
            return x >= nodeX && x <= nodeWidth && y >= nodeY && y <= nodeHeight;
        }
        function getClickedNode(x, y) {
            for (const [nodeName, coords] of Object.entries(nodeCoordinates)) {
                if (isPointInNode(x, y, coords)) {
                    return nodeName;
                }
            }
            return null;
        }
        function attachEventListeners() {
            console.log("Attaching event listeners");
            document.querySelectorAll('area').forEach(area => {
                console.log(`Attaching listeners to area with id: ${area.id}`);
                area.addEventListener('mouseover', () => showHoverIndicator(area.coords));
                area.addEventListener('mouseout', hideHoverIndicator);
                area.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log(`Clicked area with id: ${area.id}`);
                    updateTopic(area.id);
                });
            });
        }
        function updateTopic(topic) {
            console.log("updateTopic called with topic:", topic);
            fetch('/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ topic: topic, completed: !progress[topic] }),
            })
            .then(response => {
                console.log("Received response:", response);
                return response.json();
            })
            .then(data => {
                console.log("Parsed response data:", data);
                if (data.success) {
                    console.log("Update successful");
                    updateGraph(data.graph_file, data.image_map);
                    progress = data.progress;
                } else {
                    console.error("Failed to update progress");
                    alert('Failed to update progress.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating progress.');
            });
        }
        function updateGraph(graphFile, imageMap) {
            console.log("Updating graph with:", graphFile, imageMap);
            graph.src = graphFile + '?t=' + new Date().getTime();
            const parser = new DOMParser();
            const mapDoc = parser.parseFromString(imageMap, 'text/html');
            const newMap = mapDoc.querySelector('map');
            const graphContainer = document.getElementById('graph-container');
            const existingMap = document.querySelector('map');
            if (existingMap) {
                graphContainer.removeChild(existingMap);
            }
            graphContainer.appendChild(newMap);
            // Update nodeCoordinates
            nodeCoordinates = {};
            newMap.querySelectorAll('area').forEach(area => {
                const [x, y, width, height] = area.coords.split(',').map(Number);
                nodeCoordinates[area.id] = [x, y, width, height];
            });
            attachEventListeners();
            console.log("Graph updated");
        }
        graph.addEventListener('click', (e) => {
            const rect = graph.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            console.log(`Clicked at (${x}, ${y})`);
            const clickedNode = getClickedNode(x, y);
            if (clickedNode) {
                console.log(`Clicked node: ${clickedNode}`);
                updateTopic(clickedNode);
            } else {
                console.log("No matching node found for click");
            }
        });
        window.onload = function() {
            console.log("Window loaded");
            attachEventListeners();
            // Initialize nodeCoordinates
            document.querySelectorAll('area').forEach(area => {
                const [x, y, width, height] = area.coords.split(',').map(Number);
                nodeCoordinates[area.id] = [x, y, width, height];
            });
            console.log("Event listeners attached and nodeCoordinates initialized");
        };
        console.log("Script loaded and running");
    </script>
</body>
</html>